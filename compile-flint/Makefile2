##################################################################
#  Makefile that statically compiles flint and its dependencies. #
##################################################################
ifdef INSTALL_LIBS
INSTALL_MAKE =  && make install
endif
# Dirs
CURR_DIR=$(shell pwd)
OUTPUT_DIR := ${CURR_DIR}/output
SO_OUTPUT_DIR := ${OUTPUT_DIR}/shared
WASM_OUTPUT_DIR := ${OUTPUT_DIR}/wasm
BUILD_DIR := ${CURR_DIR}/build
__dummy := $(shell mkdir -p ${BUILD_DIR} ${SO_OUTPUT_DIR} ${WASM_OUTPUT_DIR})

# Libraries
FLINT_VERSION=3.1.2
FLINT=flint-${FLINT_VERSION}
FLINT_SOURCE=https://flintlib.org/${FLINT}.tar.gz

GMP_VERSION=6.3.0
GMP=gmp-${GMP_VERSION}
GMP_SOURCE=https://gmplib.org/download/gmp/${GMP}.tar.gz

MPFR_VERSION=4.2.1
MPFR=mpfr-${MPFR_VERSION}
MPFR_SOURCE=https://www.mpfr.org/mpfr-current/${MPFR}.tar.gz

# Compile flags
GMP_FLAGS= --enable-shared
MPFR_FLAGS = ${GMP_FLAGS} --with-gmp=${SO_OUTPUT_DIR}
FLINT_FLAGS= ${GMP_FLAGS} --with-gmp=${SO_OUTPUT_DIR} --with-mprf=${SO_OUTPUT_DIR}

# Map to link a library to its source
${MPFR} := MPFR
${FLINT} := FLINT
${GMP} := GMP

# Commands
COMPILE_MAKE = make -j $(shell expr $(shell nproc) + 1)
#EMCONFIGURE := emconfigure ./configure --build i686-pc-linux-gnu --disable-assembly --host=none --prefix=${WASM_OUTPUT_DIR} CFLAGS="-O3 -Wall"
#EMMAKE := emmake make -j $(shell expr $(shell nproc) + 1) && emmake make install

.PHONY: wasm shared libflint libgmp libmpfr build-clean

#all: wasm shared

#wasm: ${WASM_OUTPUT_DIR}/libflint.a

shared: ${SO_OUTPUT_DIR}/libflint.so

${SO_OUTPUT_DIR}/%.so: %
	mv $$(find ${BUILD_DIR} -name $(notdir $@)) $@
	# Update file timestamp to avoid recompilation
	touch $@

libflint: ${BUILD_DIR}/${FLINT}/ ${SO_OUTPUT_DIR}/libmpfr.so
	cd $< && ./configure ${FLINT_FLAGS} && ${COMPILE_MAKE} ${INSTALL_MAKE}

libmpfr: ${BUILD_DIR}/${MPFR}/ ${SO_OUTPUT_DIR}/libgmp.so
	cd $< && ./configure ${MPFR_FLAGS} && ${COMPILE_MAKE} ${INSTALL_MAKE}

libgmp: ${BUILD_DIR}/${GMP}/
	cd $< && ./configure ${GMP_FLAGS} && ${COMPILE_MAKE} ${INSTALL_MAKE}

${BUILD_DIR}/%/: %.tar.gz
	tar -xzf $< -C ${BUILD_DIR}

%.tar.gz:
	wget -q $($($*)_SOURCE) -O $@

build-clean:
	if [ -d ${BUILD_DIR}/${FLINT} ]; then cd ${BUILD_DIR}/${FLINT}/ && make clean; fi
	if [ -d ${BUILD_DIR}/${MPFR} ]; then cd ${BUILD_DIR}/${MPFR}/ && make clean; fi
	if [ -d ${BUILD_DIR}/${GMP} ]; then cd ${BUILD_DIR}/${GMP}/ && make clean; fi

clean:
	rm -rf ${BUILD_DIR} ${OUTPUT_DIR}
